___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Affiliate Future",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "CONVERSIONS"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Affiliate Future server-to-server (S2S) conversion tracking.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "type",
    "displayName": "Event Type",
    "radioItems": [
      {
        "value": "pageView",
        "displayValue": "Page View"
      },
      {
        "value": "conversion",
        "displayValue": "Conversion"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "pageView",
    "help": "\u003cb\u003ePage View\u003c/b\u003e \n\u003cbr/\u003e\nCaptures the Click ID from the URL and saves it to cookie for attribution:  \u003ci\u003e{affc}\u003c/i\u003e URL parameter value inside the \u003ci\u003eaffc_cid\u003c/i\u003e cookie.\n\u003cbr/\u003e\n\u003cbr/\u003e\n\u003cb\u003eConversion\u003c/b\u003e\n\u003cbr/\u003e\nSends a postback with conversion data to Affiliate Future."
  },
  {
    "type": "GROUP",
    "name": "pageViewGroup",
    "displayName": "",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "clickIdParameterName",
        "displayName": "Name of the URL parameter for the Click ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "affc",
        "help": "URL Click ID that contains rich information about the click.\n\u003cbr/\u003e\u003cbr/\u003e\nDefaults to the \u003ci\u003eaffc\u003c/i\u003e URL parameter.\n\u003cbr/\u003e\u003cbr/\u003e\nYou usually don’t need to change this, only modify it if you have a custom implementation.",
        "valueHint": "affc"
      },
      {
        "type": "GROUP",
        "name": "cookieSettingsGroup",
        "displayName": "Cookie Settings",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "TEXT",
            "name": "cookieExpiration",
            "displayName": "Cookie Expiration",
            "simpleValueType": true,
            "help": "The number of days Click ID cookie will live.\n\u003cbr\u003e\u003cbr\u003e\nSet this to, at least, the agreed cookie duration on your program settings.",
            "valueUnit": "days",
            "defaultValue": 30,
            "valueHint": "30",
            "valueValidators": [
              {
                "type": "NON_NEGATIVE_NUMBER"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "cookieDomain",
            "displayName": "Cookie Domain",
            "simpleValueType": true,
            "help": "Use this option to override the cookie domain.\n\u003cbr\u003e\nEnter your website\u0027s top-level domain as a fixed value (e.g., example.com).\n\u003cbr\u003e\nIf left as \u003ci\u003eauto\u003c/i\u003e, the domain will be automatically determined using the following priority:\n\u003cul\u003e\n\u003cli\u003eDomain of the \u003ci\u003eForwarded\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eDomain of the \u003ci\u003eX-Forwarded-Host\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eDomain of the \u003ci\u003eHost\u003c/i\u003e header.\u003c/li\u003e\n\u003c/ul\u003e",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "auto",
            "valueHint": "example.com"
          },
          {
            "type": "SELECT",
            "name": "cookieHttpOnly",
            "displayName": "Http Only Flag",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": false,
                "displayValue": "false"
              },
              {
                "value": true,
                "displayValue": "true"
              }
            ],
            "simpleValueType": true,
            "defaultValue": true
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "pageView",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "conversionGroup",
    "displayName": "",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "SELECT",
        "name": "useOptimisticScenario",
        "displayName": "Use Optimistic Scenario",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not.",
        "defaultValue": false,
        "enablingConditions": [
          {
            "paramName": "type",
            "paramValue": "userData",
            "type": "EQUALS"
          },
          {
            "paramName": "type",
            "paramValue": "conversion",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "LABEL",
        "name": "parametersOverrideGroupHelpText",
        "displayName": "By default, the tag will parse all available params from the \u003ci\u003eeventData\u003c/i\u003e. Check the Help Texts from the fields below for more details."
      },
      {
        "type": "TEXT",
        "name": "merchantId",
        "displayName": "Merchant ID",
        "simpleValueType": true,
        "help": "The Merchant ID provided by Affiliate Future.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "orderId",
        "displayName": "Order ID",
        "simpleValueType": true,
        "help": "\u003cb\u003eRequired\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nThe unique booking or order reference that identifies the conversion.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.orderId\u003c/i\u003e \u003e \u003ci\u003eeventData.order_id\u003c/i\u003e \u003e \u003ci\u003eeventData.transaction_id\u003c/i\u003e.\n\u003cbr/\u003e\nIf you do not wish to fallback to the default value, pass your own value to this field."
      },
      {
        "type": "TEXT",
        "name": "orderValue",
        "displayName": "Order Value",
        "simpleValueType": true,
        "help": "\u003cb\u003eRequired\u003c/b\u003e. \n\u003cbr/\u003e\u003cbr/\u003e\nThe order value for the transaction \u003cb\u003enet\u003c/b\u003e of any deductions. No currency symbols (e.g. £) or thousand separators should be included. Only a decimal point can be used as a separator. \n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.value\u003c/i\u003e.\n\u003cbr/\u003e\nIf you do not wish to fallback to the default value, pass your own value to this field."
      },
      {
        "type": "TEXT",
        "name": "clickId",
        "displayName": "affc Value (Click ID)",
        "simpleValueType": true,
        "help": "\u003cb\u003eRequired\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nIf left empty, this value will be automatically taken from the \u003ci\u003eaffc_cid\u003c/i\u003e cookie, which is set on pages containing the \u003ci\u003eaffc\u003c/i\u003e URL parameter. And will fallback to the \u003ci\u003eAffc\u003c/i\u003e cookie, which is set by the JS tag.\n\u003cbr/\u003e\nIf you do not wish to fallback to the default value, pass your own value to this field.\n\u003cbr/\u003e\nOnly modify it if you have a custom implementation."
      },
      {
        "type": "TEXT",
        "name": "voucher",
        "displayName": "Voucher",
        "simpleValueType": true,
        "help": "Optional.\n\u003cbr\u003e\u003cbr\u003e\nVoucher Level Tracking will allow you to track when a consumer has used a voucher code on a sale. It enables the Voucher Level Commission and Exclusive Voucher Code functionalities.\n\u003cbr\u003e\u003cbr\u003e\nDefault: \u003ci\u003eeventData.coupon\u003c/i\u003e.\n\u003cbr/\u003e\nIf you do not wish to fallback to the default value, pass your own value to this field."
      },
      {
        "type": "TEXT",
        "name": "payoutCodes",
        "displayName": "Payout Codes",
        "simpleValueType": true,
        "help": "Optional.\n\u003cbr/\u003e\u003cbr/\u003e\nSpecify payout codes to apply different commission rates to specific parts of the order.\n\u003cbr/\u003e\nThe combined payout values must not exceed 100% of the \u003ci\u003eOrder Value\u003c/i\u003e. Any discounts (e.g., from voucher codes) must be reflected in both the payout code values and the main order value.\n\u003cbr/\u003e\u003cbr/\u003e\nThe value must be a comma-separated string of payout codes and values in the following format: \u003ci\u003ePAYOUT_CODE_1,VALUE_2,PAYOUT_CODE_2,VALUE_2,...\u003c/i\u003e\n\u003cbr/\u003e\nExample: \u003ci\u003eCD,11.10,DVD,14.99\u003c/i\u003e"
      },
      {
        "type": "TEXT",
        "name": "products",
        "displayName": "Products (Product Level Tracking)",
        "simpleValueType": true,
        "help": "Optional.\n\u003cbr/\u003e\u003cbr/\u003e\nArray of products for Product Level Tracking (PLT).\n\u003cbr/\u003e\u003c/br\u003e\nThe expected format is an array of objects, each object is a product containing the properties: \n\u003cbr/\u003e\u003cbr/\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ci\u003eid\u003c/i\u003e or \u003ci\u003eitem_id\u003c/i\u003e\u003c/li\u003e\u003c/li\u003e\n\u003cli\u003e\u003ci\u003esku\u003c/i\u003e or \u003ci\u003eitem_sku\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003e\u003ci\u003ename\u003c/i\u003e or \u003ci\u003eitem_name\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003e\u003ci\u003ecategory\u003c/i\u003e or \u003ci\u003eitem_category\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003e\u003ci\u003eprice\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003e\u003ci\u003equantity\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cbr/\u003e\nDefault: \u003ci\u003eeventData.items\u003c/i\u003e. \n\u003cbr/\u003e\nIf you do not wish to fallback to the default value, pass your own value to this field."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentSettingsGroup",
    "displayName": "Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given",
            "help": "Aborts the tag execution if marketing consent (\u003ci\u003ead_storage\u003c/i\u003e Google Consent Mode or Stape\u0027s Data Tag parameter) is not given."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "userData",
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr/\u003e\u003cbr/\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "userData",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const BigQuery = require('BigQuery');
const encodeUriComponent = require('encodeUriComponent');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getCookieValues = require('getCookieValues');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeInteger = require('makeInteger');
const makeString = require('makeString');
const parseUrl = require('parseUrl');
const sendHttpRequest = require('sendHttpRequest');
const setCookie = require('setCookie');

/*==============================================================================
==============================================================================*/

const traceId = getRequestHeader('trace-id');

const eventData = getAllEventData();

const useOptimisticScenario = isUIFieldTrue(data.useOptimisticScenario);

if (!isConsentGivenOrNotRequired(data, eventData)) {
  return data.gtmOnSuccess();
}

const url = eventData.page_location || getRequestHeader('referer');
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const actionHandlers = {
  pageView: handlePageViewEvent,
  conversion: handleConversionEvent
};

const handler = actionHandlers[data.type];
if (handler) {
  handler(data, eventData);
} else {
  return data.gtmOnFailure();
}

if (useOptimisticScenario) {
  return data.gtmOnSuccess();
}

/*==============================================================================
  Vendor related functions
==============================================================================*/

function parseClickIdFromUrl(eventData) {
  const url = eventData.page_location || getRequestHeader('referer');
  if (!url) return;

  const urlSearchParams = parseUrl(url).searchParams;
  return urlSearchParams[data.clickIdParameterName || 'affc'];
}

function getClickId(data, eventData) {
  const clickId = data.hasOwnProperty('clickId')
    ? data.clickId
    : parseClickIdFromUrl(eventData) ||
      getCookieValues('affc_cid')[0] || // sGTM cookie
      getCookieValues('Affc')[0]; // JS tag cookie

  return clickId;
}

function handlePageViewEvent(data, eventData) {
  const url = eventData.page_location || getRequestHeader('referer');
  if (!url) return data.gtmOnSuccess();

  const cookieOptions = {
    domain: data.cookieDomain || 'auto',
    samesite: 'Lax',
    path: '/',
    secure: true,
    httpOnly: !!data.cookieHttpOnly,
    'max-age': 60 * 60 * 24 * makeInteger(data.cookieExpiration || 30)
  };

  const clickIdValue = parseClickIdFromUrl(eventData);
  if (clickIdValue) {
    setCookie('affc_cid', clickIdValue, cookieOptions, false);
  }

  return data.gtmOnSuccess();
}

function addProductsData(data, eventData, requestData) {
  const products = data.hasOwnProperty('products') ? data.products : eventData.items || [];
  if (getType(products) === 'array' && products.length > 0) {
    const productsForPLT = products
      .map((p) => {
        return [
          replacePipeWithUnderscore(p.item_id || p.id || ''),
          replacePipeWithUnderscore(p.item_sku || p.sku || ''),
          replacePipeWithUnderscore(p.item_name || p.name || ''),
          replacePipeWithUnderscore(p.item_category || p.category || ''),
          isValidValue(p.price) ? p.price : '',
          p.quantity || ''
        ].join('|');
      })
      .join('|,|');

    requestData.products = productsForPLT;
  }

  return requestData;
}

function mapRequestData(data, eventData) {
  const requestData = {
    merchant: data.merchantId
  };

  const orderId = data.hasOwnProperty('orderId')
    ? data.orderId
    : eventData.orderId || eventData.order_id || eventData.transaction_id;
  if (isValidValue(orderId)) requestData.orderID = orderId;

  const orderValue = data.hasOwnProperty('orderValue') ? data.orderValue : eventData.value;
  if (isValidValue(orderValue)) requestData.orderValue = orderValue;

  const clickId = getClickId(data, eventData);
  if (clickId) requestData.affc = clickId;

  const payoutCodes = data.payoutCodes;
  if (payoutCodes) requestData.payoutCodes = payoutCodes;

  const voucher = data.hasOwnProperty('voucher') ? data.voucher : eventData.coupon;
  if (voucher) requestData.voucher = voucher;

  addProductsData(data, eventData, requestData);

  return requestData;
}

function generateRequestBaseUrl() {
  return 'https://scripts.affiliatefuture.com/AFSaleV5.aspx';
}

function generateRequestOptions() {
  const options = {
    method: 'GET'
  };

  return options;
}

function generateRequestUrlParameters(requestData) {
  const requestParametersList = [];
  for (const key in requestData) {
    const value = requestData[key];
    if (!isValidValue(value)) continue;
    requestParametersList.push(enc(key) + '=' + enc(value));
  }

  return requestParametersList.join('&');
}

function areThereRequiredParametersMissing(requestData) {
  const requiredCommonFields = ['orderID', 'orderValue', 'merchant', 'affc'];
  const anyCommonFieldMissing = requiredCommonFields.some((p) => !isValidValue(requestData[p]));
  if (anyCommonFieldMissing) return requiredCommonFields;
}

function sendRequest(data, requestData) {
  const requestUrl = generateRequestBaseUrl(data) + '?' + generateRequestUrlParameters(requestData);
  const requestOptions = generateRequestOptions(data);

  log({
    Name: 'AffiliateFuture',
    Type: 'Request',
    TraceId: traceId,
    EventName: data.type,
    RequestMethod: requestOptions.method,
    RequestUrl: requestUrl
  });

  return sendHttpRequest(
    requestUrl,
    (statusCode, headers, body) => {
      log({
        Name: 'AffiliateFuture',
        Type: 'Response',
        TraceId: traceId,
        EventName: data.type,
        ResponseStatusCode: statusCode,
        ResponseHeaders: headers,
        ResponseBody: body
      });

      if (!useOptimisticScenario) {
        if (statusCode >= 200 && statusCode < 300) {
          data.gtmOnSuccess();
        } else {
          data.gtmOnFailure();
        }
      }
    },
    requestOptions
  );
}

function handleConversionEvent(data, eventData) {
  const requestData = mapRequestData(data, eventData);

  const missingParameters = areThereRequiredParametersMissing(requestData);
  if (missingParameters) {
    log({
      Name: 'AffiliateFuture',
      Type: 'Message',
      TraceId: traceId,
      EventName: data.type,
      Message: 'Request was not sent.',
      Reason: 'One or more required parameters are missing: ' + missingParameters.join(' or ')
    });

    return data.gtmOnFailure();
  }

  return sendRequest(data, requestData);
}

/*==============================================================================
  Helpers
==============================================================================*/

function replacePipeWithUnderscore(data) {
  data = data || '';
  return data.split('|').join('_');
}

function isUIFieldTrue(field) {
  return [true, 'true'].indexOf(field) !== -1;
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}

function enc(data) {
  return encodeUriComponent(makeString(data || ''));
}

function isConsentGivenOrNotRequired(data, eventData) {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;

    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key;
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  dataToLog.timestamp = getTimestampMillis();

  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  const bigquery =
    getType(BigQuery) === 'function' ? BigQuery() /* Only during Unit Tests */ : BigQuery;
  bigquery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "affc_cid"
              },
              {
                "type": 1,
                "string": "Affc"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "affc_cid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://scripts.affiliatefuture.com/AFSaleV5.aspx?*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: '[Page View] Click ID cookie is NOT set if URL doesn''t contain it'
  code: |-
    setAllMockDataByEventType('pageView');

    mock('getAllEventData', {
      page_location: 'https://example.com/'
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasNotCalled();
- name: '[Page View] Click ID cookie is set if URL contains it'
  code: |-
    setAllMockDataByEventType('pageView');

    const expectedClickId = 'expectedClickId';
    mock('getAllEventData', {
      page_location: 'https://example.com/?utm_source=affiliatefuture&affc=' + expectedClickId
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasCalledWith('affc_cid', expectedClickId, expectedCookieOptions, false);
- name: '[Page View] Click ID Cookie settings are overwritten'
  code: |-
    const cookieDomain = 'example.com';
    const cookieHttpOnly = false;
    const maxAgeDays = 1;

    const expectedOverwrittenCookieOptions = {
      domain: cookieDomain,
      samesite: 'Lax',
      path: '/',
      secure: true,
      httpOnly: cookieHttpOnly,
      'max-age': 60 * 60 * 24 * maxAgeDays
    };

    setAllMockDataByEventType('pageView', {
      cookieDomain: cookieDomain,
      cookieExpiration: maxAgeDays,
      cookieHttpOnly: cookieHttpOnly
    });

    const expectedClickId = 'expectedClickId';
    mock('getAllEventData', {
      page_location: 'https://example.com/?utm_source=affiliatefuture&affc=' + expectedClickId
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasCalledWith('affc_cid', expectedClickId, expectedOverwrittenCookieOptions, false);
- name: '[Conversion] Request is not sent if required parameters are missing'
  code: "const originalMockData = setAllMockDataByEventType('conversion');\n\n[\n\
    \  { orderId: undefined },\n  { orderValue: undefined },\n  { merchantId: undefined\
    \ },\n  { clickId: undefined }\n].forEach((scenario) => {\n  const copyMockData\
    \ = JSON.parse(JSON.stringify(originalMockData));\n  mergeObj(copyMockData, scenario);\n\
    \  \n  runCode(copyMockData);\n  \n  assertApi('sendHttpRequest').wasNotCalled();\n\
    \  assertApi('gtmOnSuccess').wasNotCalled();\n  assertApi('gtmOnFailure').wasCalled();\n\
    });\n"
- name: '[Conversion] Request Base URL is correctly built'
  code: |-
    setAllMockDataByEventType('conversion');

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedUrl = parseUrl(requestUrl);
      assertThat(parsedUrl.origin + parsedUrl.pathname).isEqualTo('https://scripts.affiliatefuture.com/AFSaleV5.aspx');
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Conversion] Request Options is correctly built'
  code: |-
    setAllMockDataByEventType('conversion');

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      assertThat(requestOptions).isEqualTo({
        method: 'GET'
      });
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Conversion] [Data from UI fields] Request is successfully built and sent'
  code: |-
    setAllMockDataByEventType('conversion');

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      assertThat(requestUrl).isEqualTo("https://scripts.affiliatefuture.com/AFSaleV5.aspx?merchant=7591&orderID=6468464&orderValue=1&affc=73b77cc0-8d58-4bf7-a8d0-2f84cedccfe3&payoutCodes=payout&voucher=vouchertest&products=SKU_12345%7C%7CStan%20and%20Friends%20Tee%7CApparel_iajsdiajsd_oasodiasd%7C10.01%7C3%7C%2C%7CSKU_12346%7C%7CGoogle%20Grey%20Women's%20(Tee)%7CApparel_iajsdiajsd_oasodiasd%7C21.01%7C2");
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Conversion] [Data from UI fields fallbacks] Request is successfully built
    and sent'
  code: |-
    setAllMockDataByEventType('conversion');
    ['orderId', 'orderValue', 'clickId', 'voucher', 'products'].forEach(p => Object.delete(mockData, p));

    setGetAllEventData();

    mock('getCookieValues', (cookieName) => {
      if (cookieName === 'affc_cid') return ['affcFromServerCookie'];
      return [];
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      assertThat(requestUrl).isEqualTo("https://scripts.affiliatefuture.com/AFSaleV5.aspx?merchant=7591&orderID=transactionId&orderValue=123.45&affc=affcFromServerCookie&payoutCodes=payout&voucher=coupon&products=SKU_12345%7C%7CStan%20and%20Friends%20Tee%7CApparel_iajsdiajsd_oasodiasd%7C10.01%7C3%7C%2C%7CSKU_12346%7C%7CGoogle%20Grey%20Women's%20(Tee)%7CApparel_iajsdiajsd_oasodiasd%7C21.01%7C2");
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Conversion] [Click ID Cookie from JS tag] Request is successfully built
    and sent'
  code: |-
    setAllMockDataByEventType('conversion');
    Object.delete(mockData, 'clickId');

    mock('getCookieValues', (cookieName) => {
      if (cookieName === 'Affc') return ['affcFromJSTagCookie'];
      return [];
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      assertThat(requestUrl).isEqualTo("https://scripts.affiliatefuture.com/AFSaleV5.aspx?merchant=7591&orderID=6468464&orderValue=1&affc=affcFromJSTagCookie&payoutCodes=payout&voucher=vouchertest&products=SKU_12345%7C%7CStan%20and%20Friends%20Tee%7CApparel_iajsdiajsd_oasodiasd%7C10.01%7C3%7C%2C%7CSKU_12346%7C%7CGoogle%20Grey%20Women's%20(Tee)%7CApparel_iajsdiajsd_oasodiasd%7C21.01%7C2");
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Logs] Should log to console, if the ''Always log to console'' option is
    selected'
  code: "setAllMockDataByEventType('conversion', {\n  logType: 'always'\n});\n\nconst\
    \ expectedDebugMode = true;\nmock('getContainerVersion', () => {\n  return {\n\
    \    debugMode: expectedDebugMode\n  };\n}); \n\nmock('logToConsole', (logData)\
    \ => {\n  const parsedLogData = JSON.parse(logData);\n  requiredConsoleKeys.forEach(p\
    \ => assertThat(parsedLogData[p]).isDefined());\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, callback, requestOptions) => {\n  callback(200);\n});\n\nrunCode(mockData);\n\
    \nassertApi('logToConsole').wasCalled();\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('gtmOnFailure').wasNotCalled();"
- name: '[Logs] Should log to console, if the ''Log during debug and preview'' option
    is selected AND is on preview mode'
  code: |-
    setAllMockDataByEventType('conversion', {
      logType: 'debug'
    });

    const expectedDebugMode = true;
    mock('getContainerVersion', () => {
      return {
        debugMode: expectedDebugMode
      };
    });

    mock('logToConsole', (logData) => {
      const parsedLogData = JSON.parse(logData);
      requiredConsoleKeys.forEach(p => assertThat(parsedLogData[p]).isDefined());
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      callback(200);
    });

    runCode(mockData);

    assertApi('logToConsole').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Logs] Should NOT log to console, if the ''Log during debug and preview''
    option is selected AND is NOT on preview mode'
  code: "setAllMockDataByEventType('conversion', {\n  logType: 'debug'\n});\n\nconst\
    \ expectedDebugMode = false;\nmock('getContainerVersion', () => {\n  return {\n\
    \    debugMode: expectedDebugMode\n  };\n}); \n\nmock('sendHttpRequest', (requestUrl,\
    \ callback, requestOptions, requestBody) => {\n  callback(200);\n});\n\nrunCode(mockData);\n\
    \nassertApi('logToConsole').wasNotCalled();\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('gtmOnFailure').wasNotCalled();"
- name: '[Logs] Should NOT log to console, if the ''Do not log'' option is selected'
  code: |-
    setAllMockDataByEventType('conversion', {
      logType: 'no'
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      callback(200);
    });

    runCode(mockData);

    assertApi('logToConsole').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Logs] Should log to BQ, if the ''Log to BigQuery'' option is selected'
  code: "setAllMockDataByEventType('conversion', {\n  bigQueryLogType: 'always'\n\
    });\n\n// assertApi doesn't work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mock('BigQuery', () => {\n  return { \n    insert: (connectionInfo, rows, options)\
    \ => { \n      assertThat(connectionInfo).isDefined();\n      assertThat(rows).isArray();\n\
    \      assertThat(rows).hasLength(1);\n      requiredBqKeys.forEach(p => assertThat(rows[0][p]).isDefined());\n\
    \      assertThat(options).isEqualTo(expectedBqOptions);\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve();\n      });\n    }\n  };\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, callback, requestOptions, requestBody) => {\n  callback(200, {},\
    \ JSON.stringify({ success: true }));\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('gtmOnFailure').wasNotCalled();"
- name: '[Logs] Should NOT log to BQ, if the ''Do not log to BigQuery'' option is
    selected'
  code: "setAllMockDataByEventType('conversion', {\n  bigQueryLogType: 'no'\n});\n\
    \n// assertApi doesn't work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mock('BigQuery', () => {\n  return { \n    insert: (connectionInfo, rows, options)\
    \ => { \n      fail('BigQuery.insert should not have been called.');\n      return\
    \ Promise.create((resolve, reject) => {\n        resolve();\n      });\n    }\n\
    \  };\n});\n\nmock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody)\
    \ => {\n  callback(200, {}, JSON.stringify({ success: true }));\n});\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
setup: "const JSON = require('JSON');\nconst Promise = require('Promise');\nconst\
  \ parseUrl = require('parseUrl');\nconst Object = require('Object');\n\nfunction\
  \ mergeObj(target, source) {\n  for (const key in source) {\n    if (source.hasOwnProperty(key))\
  \ target[key] = source[key];\n  }\n  return target;\n}\n\nconst items = [\n  {\n\
  \    item_id: 'SKU_12345',\n    item_name: 'Stan and Friends Tee',\n    affiliation:\
  \ 'Google Merchandise Store',\n    coupon: 'SUMMER_FUN',\n    discount: 2.22,\n\
  \    index: 0,\n    item_brand: 'Google',\n    item_category: 'Apparel|iajsdiajsd|oasodiasd',\n\
  \    item_list_id: 'related_products',\n    item_list_name: 'Related Products',\n\
  \    item_variant: 'green',\n    location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n \
  \   price: 10.01,\n    quantity: 3,\n    item_group_id: 'abc'\n  },\n  {\n    item_id:\
  \ 'SKU_12346',\n    item_name: \"Google Grey Women's (Tee)\",\n    affiliation:\
  \ 'Google Merchandise Store',\n    coupon: 'SUMMER_FUN',\n    discount: 3.33,\n\
  \    index: 1,\n    item_brand: 'Google',\n    item_category: 'Apparel|iajsdiajsd|oasodiasd',\n\
  \    item_list_id: 'related_products',\n    item_list_name: 'Related Products',\n\
  \    item_variant: 'gray',\n    location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n  \
  \  price: 21.01,\n    promotion_id: 'P_12345',\n    promotion_name: 'Summer Sale',\n\
  \    quantity: 2,\n    item_group_id: 'xyz'\n  }\n];\n\nconst setGetAllEventData\
  \ = (objToBeMerged) => {\n  mock('getAllEventData', mergeObj({\n    'x-ga-protocol_version':\
  \ '2',\n    'x-ga-measurement_id': 'G-123ABC',\n    'x-ga-gtm_version': '45je55e1za200',\n\
  \    'x-ga-page_id': 1747422523211,\n    'x-ga-gcd': '13l3l3l3l1l1',\n    'x-ga-npa':\
  \ '0',\n    'x-ga-dma': '0',\n    'x-ga-mp2-tag_exp':\n      '101509157~103116025~103130498~103130500~103136993~103136995~103200001~103207802~103211513~103233427~103252644~103252646~103263073~103301114~103301116',\n\
  \    client_id: 'AUJctU7H7hBB/aMuhE4pKwGu5DWDdklg5abyyyn8i/I=.1747154479',\n   \
  \ 'x-ga-ecid': '1294673677',\n    language: 'en-us',\n    screen_resolution: '1512x982',\n\
  \    event_location: { country: 'BR', region: 'SP' },\n    event_id: '101509157~103116025~103130498',\n\
  \    timestamp: 1748377016,\n    client_hints: {\n      architecture: 'arm',\n \
  \     bitness: '64',\n      full_version_list: [\n        { brand: 'Chromium', version:\
  \ '136.0.7103.93' },\n        { brand: 'Google Chrome', version: '136.0.7103.93'\
  \ },\n        { brand: 'Not.A/Brand', version: '99.0.0.0' }\n      ],\n      mobile:\
  \ false,\n      model: '',\n      platform: 'macOS',\n      platform_version: '15.2.0',\n\
  \      wow64: false,\n      brands: [\n        { brand: 'Chromium', version: '136'\
  \ },\n        { brand: 'Google Chrome', version: '136' },\n        { brand: 'Not.A/Brand',\
  \ version: '99' }\n      ]\n    },\n    'x-ga-are': '1',\n    'x-ga-mp2-frm': '0',\n\
  \    'x-ga-pscdl': 'noapi',\n    'x-ga-system_properties': { eu: [34], tu: 'BA',\
  \ ss: '1', ee: true },\n    'x-sst-system_properties': {\n      etld: 'google.com.br',\n\
  \      tft: '1747422523211',\n      lpc: '60493049',\n      navt: 'r',\n      ude:\
  \ '0',\n      sw_exp: '1',\n      request_start_time_ms: 1747422524851\n    },\n\
  \    'x-ga-request_count': 1,\n    ga_session_id: '1747422523',\n    ga_session_number:\
  \ 3,\n    'x-ga-mp2-seg': '0',\n    page_location: 'https://example.com/?test=1i23i21j3',\n\
  \    page_title: 'Example Domain',\n    event_name: 'page_view',\n    'x-ga-tfd':\
  \ 5784,\n    ip_override: '2804:14d:c096:8dd6:311c:8c00:e6c:e33',\n    user_agent:\n\
  \      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML,\
  \ like Gecko) Chrome/136.0.0.0 Safari/537.36',\n    transaction_id: 'transactionId',\n\
  \    value: 123.45,\n    currency: 'BRL',\n    user_id: 'userId',\n    user_data:\
  \ {\n      email: { 0: 'userEmail', 1: 'test2@example.net' },\n      phone_number:\
  \ '+55 (19) 99999-9999'\n    },\n    coupon: 'coupon',\n    items: items\n  }, objToBeMerged\
  \ || {}));\n};\n\nconst expectedCookieOptions = {\n  domain: 'auto',\n  samesite:\
  \ 'Lax',\n  path: '/',\n  secure: true,\n  httpOnly: true,\n  'max-age': 2592000\n\
  };\n\nconst expectedBigQuerySettings = {\n  logBigQueryProjectId: 'logBigQueryProjectId',\n\
  \  logBigQueryDatasetId: 'logBigQueryDatasetId',\n  logBigQueryTableId: 'logBigQueryTableId'\n\
  };\n\nconst requiredConsoleKeys = ['Type', 'TraceId', 'Name'];\nconst requiredBqKeys\
  \ = ['timestamp', 'type', 'trace_id', 'tag_name'];\nconst expectedBqOptions = {\
  \ ignoreUnknownValues: true };\n\nconst mockData = {\n  adStorageConsent: 'optional',\n\
  };\n\nconst setAllMockDataByEventType = (type, objToBeMerged) => {\n  const mockDataByEventType\
  \ = {\n    pageView: {\n      type: 'pageView',\n      clickIdParameterName: 'affc',\n\
  \      cookieDomain: 'auto',\n      cookieHttpOnly: true,\n      cookieExpiration:\
  \ '30',\n    },\n    conversion: {\n      type: 'conversion',\n      merchantId:\
  \ '7591',\n      orderId: '6468464',\n      orderValue: '1',\n      clickId: '73b77cc0-8d58-4bf7-a8d0-2f84cedccfe3',\n\
  \      voucher: 'vouchertest',\n      payoutCodes: 'payout',\n      products: items,\n\
  \      useOptimisticScenario: false,\n      logType: 'debug',\n      bigQueryLogType:\
  \ 'no',\n      logBigQueryProjectId: expectedBigQuerySettings.logBigQueryProjectId,\n\
  \      logBigQueryDatasetId: expectedBigQuerySettings.logBigQueryDatasetId,\n  \
  \    logBigQueryTableId: expectedBigQuerySettings.logBigQueryTableId\n    }\n  };\n\
  \  \n  mergeObj(mockDataByEventType[type], objToBeMerged || {});\n  mergeObj(mockData,\
  \ mockDataByEventType[type]);\n  return mockData;\n};\n\nmock('sendHttpRequest',\
  \ (requestUrl, callback, requestOptions, requestBody) => {\n  if (typeof callback\
  \ === 'function') {\n    callback(200);\n  } else {\n    requestBody = requestOptions;\n\
  \    requestOptions = callback;\n    return Promise.create((resolve, reject) =>\
  \ {\n      resolve({ statusCode: 200 });\n    });  \n  }\n});\n\nmock('getRequestHeader',\
  \ (header) => {\n  if (header === 'trace-id') return 'expectedTraceId';\n});\n\n\
  mock('getTimestampMillis', 1747945830456);"


___NOTES___

Created on 7/31/2025, 6:02:27 PM

